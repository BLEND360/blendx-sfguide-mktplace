name: Release to Production (directive:default)

on:
  push:
    tags:
      - 'release/*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (leave empty to auto-detect from QA)'
        required: false
        default: ''
      patch:
        description: 'Patch number to release (leave empty to auto-detect from QA)'
        required: false
        default: ''

jobs:
  release-to-production:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Verify signed release tag
        run: |
          git fetch --tags --force
          TAG="${GITHUB_REF#refs/tags/}"

          echo "Verifying signature for tag: $TAG"
          git tag -v "$TAG" || {
            echo "::error::Release tag is not signed or signature is invalid"
            exit 1
          }

      - name: Install Snowflake CLI
        uses: snowflakedb/snowflake-cli-action@v1.5
        with:
          cli-version: "3.6.0"

      - name: Setup Snowflake CLI PATH
        run: echo "$HOME/.snowflake-cli/bin" >> $GITHUB_PATH

      - name: Prepare Snowflake JWT key
        run: |
          echo "${{ secrets.SNOWFLAKE_PRIVATE_KEY_RAW }}" > snowflake_jwt_key.pem
          chmod 600 snowflake_jwt_key.pem

      - name: Configure Snowflake connection
        run: |
          snow connection add \
            --connection-name mkt_blendx_demo \
            --account ${{ secrets.SNOWFLAKE_ACCOUNT }} \
            --user ${{ secrets.SNOWFLAKE_DEPLOY_USER }} \
            --role ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }} \
            --warehouse ${{ secrets.SNOWFLAKE_WAREHOUSE }} \
            --database ${{ secrets.SNOWFLAKE_DATABASE }} \
            --schema ${{ secrets.SNOWFLAKE_SCHEMA }} \
            --host ${{ secrets.SNOWFLAKE_HOST }} \
            --port 443 \
            --authenticator SNOWFLAKE_JWT \
            --private-key-file snowflake_jwt_key.pem \
            --no-interactive

      - name: Test Snowflake connection
        run: snow connection test --connection mkt_blendx_demo

      - name: Validate release prerequisites
        run: |
          echo "=========================================="
          echo "Pre-release validation"
          echo "=========================================="

          # Verify application package exists and has at least one QA version
          QA_ROW=$(snow sql -q "
            USE ROLE ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }};
            SHOW VERSIONS IN APPLICATION PACKAGE ${{ secrets.SNOWFLAKE_APP_PACKAGE }};
          " --connection mkt_blendx_demo \
            | grep -i "| *QA *|" \
            | tail -1 || true)

          if [ -z "$QA_ROW" ]; then
            echo "::error::No versions found in QA release channel. Deploy to QA first."
            exit 1
          fi

          echo "âœ“ QA release channel has at least one version"
          echo "Pre-release validation passed"

      - name: Auto-detect version and patch from QA channel
        id: detect_version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PATCH="${{ github.event.inputs.patch }}"

          VERSIONS_JSON=$(snow sql -q "
          USE ROLE ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }};
          SHOW VERSIONS IN APPLICATION PACKAGE ${{ secrets.SNOWFLAKE_APP_PACKAGE }};
          " --connection mkt_blendx_demo -o json)

          QA_VERSIONS=$(echo "$VERSIONS_JSON" | jq '[.[] | select(.release_channel_name | ascii_upcase=="QA")]')

          COUNT=$(echo "$QA_VERSIONS" | jq 'length')
          if [ "$COUNT" -eq "0" ]; then
            echo "::error::No versions found in QA release channel. Cannot promote to production."
            exit 1
          fi

          LATEST=$(echo "$QA_VERSIONS" | jq -r 'sort_by(.created_on) | last')

          if [ -z "$VERSION" ]; then
            VERSION=$(echo "$LATEST" | jq -r '.version')
            echo "Detected version from QA: $VERSION"
          fi

          if [ -z "$PATCH" ]; then
            PATCH=$(echo "$LATEST" | jq -r '.patch')
            echo "Detected patch from QA: $PATCH"
          fi

          if [ -z "$VERSION" ] || [ -z "$PATCH" ]; then
            echo "::error::Unable to determine version or patch from QA"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT

          echo "=========================================="
          echo "Release Configuration:"
          echo "  Version: $VERSION"
          echo "  Patch: $PATCH"
          echo "  Source Release Channel: QA"
          echo "  Target Release Channel: DEFAULT"
          echo "=========================================="

      - name: Verify version exists
        run: |
          VERSION="${{ steps.detect_version.outputs.version }}"
          PATCH="${{ steps.detect_version.outputs.patch }}"

          echo "Verifying version $VERSION patch $PATCH exists..."

          # Use JSON output for reliable parsing
          VERSIONS_JSON=$(snow sql -q "USE ROLE ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }}; SHOW VERSIONS IN APPLICATION PACKAGE ${{ secrets.SNOWFLAKE_APP_PACKAGE }};" \
            --connection mkt_blendx_demo -o json 2>/dev/null) || VERSIONS_JSON="[]"

          VERSION_EXISTS=$(echo "$VERSIONS_JSON" | jq -r --arg v "$VERSION" '[.[] | select(.version | ascii_upcase == ($v | ascii_upcase))] | length')

          if [ "$VERSION_EXISTS" -eq "0" ]; then
            echo "Error: Version ${VERSION} does not exist in package ${{ secrets.SNOWFLAKE_APP_PACKAGE }}"
            echo ""
            echo "Available versions:"
            echo "$VERSIONS_JSON" | jq '.'
            exit 1
          fi

          echo "Version ${VERSION} exists"

      - name: Validate PROD release monotonicity
        run: |
          echo "Validating PROD release monotonicity..."

          VERSION="${{ steps.detect_version.outputs.version }}"
          PATCH="${{ steps.detect_version.outputs.patch }}"

          VERSIONS_JSON=$(snow sql -q "
          USE ROLE ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }};
          SHOW VERSIONS IN APPLICATION PACKAGE ${{ secrets.SNOWFLAKE_APP_PACKAGE }};
          " --connection mkt_blendx_demo -o json)

          CURRENT=$(echo "$VERSIONS_JSON" | jq -r '
            [.[] | select(.release_channel_name=="DEFAULT")]
            | sort_by(.created_on)
            | last // empty
          ')

          if [ -n "$CURRENT" ]; then
            CUR_VERSION=$(echo "$CURRENT" | jq -r '.version' | sed 's/V//')
            CUR_PATCH=$(echo "$CURRENT" | jq -r '.patch')

            NEW_VERSION=$(echo "$VERSION" | sed 's/V//')
            NEW_PATCH="$PATCH"

            echo "Current PROD: V$CUR_VERSION patch $CUR_PATCH"
            echo "New PROD:     V$NEW_VERSION patch $NEW_PATCH"

            if [ "$NEW_VERSION" -lt "$CUR_VERSION" ] || \
               { [ "$NEW_VERSION" -eq "$CUR_VERSION" ] && [ "$NEW_PATCH" -le "$CUR_PATCH" ]; }; then
              echo "::error::PROD release regression detected. Refusing to move production backwards."
              exit 1
            fi
          else
            echo "No existing PROD release found (first production release)."
          fi

      - name: Add version to DEFAULT release channel
        run: |
          VERSION="${{ steps.detect_version.outputs.version }}"

          CHANNEL_JSON=$(snow sql -q "USE ROLE ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }}; SHOW RELEASE DIRECTIVES IN APPLICATION PACKAGE ${{ secrets.SNOWFLAKE_APP_PACKAGE }};" \
            --connection mkt_blendx_demo -o json 2>/dev/null) || CHANNEL_JSON="[]"

          IN_DEFAULT=$(echo "$CHANNEL_JSON" | jq -r --arg v "$VERSION" '[.[] | select(.channel | ascii_upcase=="DEFAULT" and .version | ascii_upcase==($v|ascii_upcase))] | length')

          if [ "$IN_DEFAULT" -eq "0" ]; then
            echo "Adding version $VERSION to DEFAULT release channel..."
            snow sql -q "USE ROLE ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }}; ALTER APPLICATION PACKAGE ${{ secrets.SNOWFLAKE_APP_PACKAGE }} MODIFY RELEASE CHANNEL DEFAULT ADD VERSION ${VERSION};" --connection mkt_blendx_demo
          else
            echo "Version $VERSION already present in DEFAULT channel"
          fi

      - name: Set DEFAULT release directive
        run: |
          VERSION="${{ steps.detect_version.outputs.version }}"
          PATCH="${{ steps.detect_version.outputs.patch }}"

          echo "Setting DEFAULT release directive to version $VERSION patch $PATCH..."
          snow sql -q "USE ROLE ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }}; ALTER APPLICATION PACKAGE ${{ secrets.SNOWFLAKE_APP_PACKAGE }} MODIFY RELEASE CHANNEL DEFAULT SET DEFAULT RELEASE DIRECTIVE VERSION=${VERSION} PATCH=${PATCH};" --connection mkt_blendx_demo

      - name: Show current release status
        run: |
          echo ""
          echo "=========================================="
          echo "Current Release Status"
          echo "=========================================="

          echo ""
          echo "Versions:"
          snow sql -q "USE ROLE ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }}; SHOW VERSIONS IN APPLICATION PACKAGE ${{ secrets.SNOWFLAKE_APP_PACKAGE }};" --connection mkt_blendx_demo

          echo ""
          echo "Release Directives:"
          snow sql -q "USE ROLE ${{ secrets.SNOWFLAKE_DEPLOY_ROLE }}; SHOW RELEASE DIRECTIVES IN APPLICATION PACKAGE ${{ secrets.SNOWFLAKE_APP_PACKAGE }};" --connection mkt_blendx_demo

      - name: Summary
        run: |
          VERSION="${{ steps.detect_version.outputs.version }}"
          PATCH="${{ steps.detect_version.outputs.patch }}"

          echo ""
          echo "=========================================="
          echo "Production Release completed!"
          echo "=========================================="
          echo ""
          echo "Version $VERSION patch $PATCH has been promoted to the DEFAULT channel."
          echo ""
          echo "Next steps:"
          echo "  1. If not yet done, submit for security review in Provider Studio"
          echo "  2. Wait for Snowflake to approve the version (1-3 business days)"
          echo "  3. Once approved, the version will be available to marketplace consumers"
          echo ""
          echo "Provider Studio: https://app.snowflake.com > Provider Studio > Listings"
